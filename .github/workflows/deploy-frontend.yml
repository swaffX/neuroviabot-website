name: ðŸŒ Deploy Frontend Only

on:
  push:
    branches:
      - main
    paths:
      - 'neuroviabot-frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:

jobs:
  deploy-frontend:
    name: ðŸŒ Deploy Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Pull Latest Frontend Code
        uses: appleboy/ssh-action@v1.0.3
        continue-on-error: true
        id: pull_code_attempt1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 30m
          script: |
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“¥ FRONTEND: Pulling Latest Changes"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cd /root/neuroviabot/bot
            git fetch origin main
            git reset --hard origin/main
            echo "âœ… Frontend code updated"
            echo ""

      - name: ðŸ“¥ Pull Latest Frontend Code (Retry)
        if: steps.pull_code_attempt1.outcome == 'failure'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 30m
          script: |
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ”„ FRONTEND: Retrying Pull (Attempt 2)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cd /root/neuroviabot/bot
            git fetch origin main
            git reset --hard origin/main
            echo "âœ… Frontend code updated (retry successful)"
            echo ""

      - name: ðŸ—‘ï¸ Clean Frontend Build
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 30m
          script: |
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ—‘ï¸ FRONTEND: Cleaning Build"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cd /root/neuroviabot/bot/neuroviabot-frontend
            rm -rf node_modules package-lock.json .next out
            echo "âœ… Build cleaned"
            echo ""

      - name: ðŸ“¦ Install Frontend Dependencies
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 30m
          script: |
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“¦ FRONTEND: Installing Dependencies"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cd /root/neuroviabot/bot/neuroviabot-frontend
            
            # Check Node.js version
            echo "ðŸ”¹ Node.js version: $(node --version)"
            echo "ðŸ”¹ NPM version: $(npm --version)"
            
            # Clean npm cache to avoid corrupted package issues
            echo "ðŸ§¹ Cleaning npm cache..."
            npm cache clean --force
            
            # Install dependencies with legacy peer deps for compatibility
            npm install --legacy-peer-deps
            INSTALL_EXIT_CODE=$?
            
            if [ $INSTALL_EXIT_CODE -eq 0 ]; then
              echo "âœ… Dependencies installed successfully"
              
              # Verify critical packages
              if [ -f "node_modules/.bin/next" ]; then
                echo "âœ… Next.js binary found"
              else
                echo "âŒ Next.js binary NOT FOUND after install!"
                echo "ðŸš¨ Critical dependency missing"
                exit 1
              fi
            else
              echo "âŒ npm install FAILED with exit code $INSTALL_EXIT_CODE"
              exit 1
            fi
            echo ""

      - name: ðŸ—ï¸ Build Frontend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 30m
          script: |
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ—ï¸ FRONTEND: Building Application"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cd /root/neuroviabot/bot/neuroviabot-frontend
            
            # Run build and capture exit code
            npm run build
            BUILD_EXIT_CODE=$?
            
            if [ $BUILD_EXIT_CODE -eq 0 ]; then
              echo "âœ… Build completed successfully"
              
              # Verify .next directory was created
              if [ -d ".next" ]; then
                echo "âœ… .next build directory found"
              else
                echo "âŒ .next directory NOT FOUND after build!"
                exit 1
              fi
            else
              echo "âŒ Build FAILED with exit code $BUILD_EXIT_CODE"
              exit 1
            fi
            echo ""

      - name: ðŸ”„ Restart Frontend Service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 30m
          script: |
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ”„ PM2: Restarting Frontend"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Go to project directory
            cd /root/neuroviabot/bot
            
            # Stop and delete frontend if exists
            echo "ðŸ›¡ï¸ Stopping existing frontend process..."
            pm2 stop neuroviabot-frontend 2>/dev/null || echo "â„¹ï¸ Frontend was not running"
            pm2 delete neuroviabot-frontend 2>/dev/null || echo "â„¹ï¸ Frontend was not in PM2"
            
            # Verify build exists before starting
            echo "ðŸ” Verifying frontend build..."
            if [ -d "/root/neuroviabot/bot/neuroviabot-frontend/.next" ]; then
              echo "âœ… Frontend build found (.next directory exists)"
            else
              echo "âŒ Frontend build NOT FOUND!"
              echo "ðŸš¨ .next directory is missing. Build may have failed."
              exit 1
            fi
            
            # Start with ecosystem config
            echo "ðŸš€ Starting frontend with PM2..."
            pm2 start PM2-ECOSYSTEM.config.js --only neuroviabot-frontend
            
            # Check if start was successful
            if [ $? -eq 0 ]; then
              echo "âœ… PM2 start command executed"
              pm2 save
              echo "âœ… PM2 configuration saved"
            else
              echo "âŒ PM2 start command FAILED"
              exit 1
            fi
            
            echo ""

      - name: âœ… Verify Frontend Status
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 30m
          script: |
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… FRONTEND DEPLOYMENT COMPLETED!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Wait for startup
            echo "â³ Waiting 10 seconds for frontend to start..."
            sleep 10
            
            # Show ALL PM2 processes
            echo "ðŸ“Š All PM2 Processes:"
            pm2 list
            
            # Check if frontend exists in PM2
            echo ""
            echo "ðŸ” Checking Frontend Status:"
            if pm2 list | grep -q "neuroviabot-frontend"; then
              # Show frontend logs
              echo "ðŸ“‹ Frontend Logs:"
              pm2 logs neuroviabot-frontend --lines 30 --nostream || echo "âš ï¸ Could not fetch logs"
              
              # Check if online
              if pm2 list | grep "neuroviabot-frontend" | grep -q "online"; then
                echo "âœ… Frontend is ONLINE"
              else
                echo "âš ï¸ Frontend exists but status is not online"
                pm2 describe neuroviabot-frontend
                exit 1
              fi
            else
              echo "âŒ Frontend process NOT FOUND in PM2"
              echo "ðŸ’¡ Checking if PM2 config exists:"
              ls -la /root/neuroviabot/bot/PM2-ECOSYSTEM.config.js
              exit 1
            fi

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "### ðŸŒ Frontend Deployment Completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Frontend | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
