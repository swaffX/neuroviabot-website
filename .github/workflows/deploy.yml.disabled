name: ğŸš€ Deploy NeuroViaBot to VPS

# Bu iÅŸ akÄ±ÅŸÄ± ne zaman Ã§alÄ±ÅŸacak?
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    # Bu iÅŸlerin Ã§alÄ±ÅŸacaÄŸÄ± sanal makine
    runs-on: ubuntu-latest

    steps:
      # ==========================================
      # STEP 1: CHECKOUT CODE
      # ==========================================
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==========================================
      # STEP 2: SETUP NODE.JS
      # ==========================================
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ==========================================
      # BOT BUILD - TAMAMEN TEMÄ°Z KURULUM
      # ==========================================
      - name: ğŸ¤– Clean Bot
        run: |
          echo "ğŸ§¹ Bot iÃ§in tÃ¼m geÃ§ici dosyalar temizleniyor..."
          rm -rf node_modules
          rm -rf package-lock.json
          echo "âœ… Bot temizlendi"

      - name: ğŸ¤– Install Bot Dependencies
        run: |
          echo "ğŸ“¦ Bot baÄŸÄ±mlÄ±lÄ±klarÄ± kuruluyor..."
          npm install --omit=dev
          echo "âœ… Bot baÄŸÄ±mlÄ±lÄ±klarÄ± kuruldu"

      - name: ğŸ“¦ Archive Bot
        run: |
          echo "ğŸ“¦ Bot arÅŸivleniyor..."
          tar --exclude='frontend' --exclude='backend' --exclude='.git' --exclude='node_modules' \
              -czvf bot.tar.gz . || {
            code=$?
            echo "UyarÄ±: tar iÅŸlemi kod $code dÃ¶ndÃ¼ (genellikle sorun deÄŸil)";
            exit 0;
          }
          echo "âœ… Bot arÅŸivlendi"

      # ==========================================
      # FRONTEND BUILD - TAMAMEN TEMÄ°Z KURULUM
      # ==========================================
      - name: ğŸŒ Clean Frontend Completely
        run: |
          echo "ğŸ§¹ Frontend iÃ§in tÃ¼m geÃ§ici dosyalar temizleniyor..."
          cd frontend
          rm -rf node_modules
          rm -rf .next
          rm -rf .cache
          rm -rf out
          rm -rf package-lock.json
          echo "âœ… Frontend tamamen temizlendi"
          cd ..

      - name: ğŸŒ Install Frontend Dependencies (ALL - with TypeScript)
        run: |
          echo "ğŸ“¦ Frontend TÃœÃœN baÄŸÄ±mlÄ±lÄ±klarÄ± kuruluyor (TypeScript dahil)..."
          cd frontend
          npm install
          echo "âœ… Frontend tÃ¼m baÄŸÄ±mlÄ±lÄ±klarÄ± kuruldu"
          cd ..

      - name: ğŸŒ Build Frontend (Next.js with TypeScript)
        env:
          NEXT_PUBLIC_API_URL: https://neuroviabot.xyz
          NEXT_PUBLIC_BOT_CLIENT_ID: ${{ secrets.DISCORD_CLIENT_ID }}
          NODE_ENV: production
        run: |
          echo "ğŸ—ï¸ Next.js build baÅŸlÄ±yor (TypeScript dahil)..."
          cd frontend
          npm run build
          echo "âœ… Frontend build tamamlandÄ±"
          cd ..

      - name: ğŸŒ Prepare Frontend for Production
        run: |
          echo "ğŸ§¹ Frontend production iÃ§in hazÄ±rlanÄ±yor..."
          cd frontend
          # DevDependencies'i kaldÄ±r (TypeScript, @types/* vs.)
          npm prune --production
          echo "âœ… Frontend production iÃ§in hazÄ±r"
          cd ..

      - name: ğŸ“¦ Archive Frontend
        run: |
          echo "ğŸ“¦ Frontend arÅŸivleniyor..."
          tar --exclude='node_modules' --exclude='.next/cache' -czvf frontend.tar.gz -C frontend . || {
            code=$?
            echo "UyarÄ±: tar iÅŸlemi kod $code dÃ¶ndÃ¼ (genellikle sorun deÄŸil)";
            exit 0;
          }
          echo "âœ… Frontend arÅŸivlendi"

      # ==========================================
      # BACKEND BUILD - TAMAMEN TEMÄ°Z KURULUM
      # ==========================================
      - name: âš™ï¸ Clean Backend Completely
        run: |
          echo "ğŸ§¹ Backend iÃ§in tÃ¼m geÃ§ici dosyalar temizleniyor..."
          cd backend
          rm -rf node_modules
          rm -rf package-lock.json
          echo "âœ… Backend tamamen temizlendi"
          cd ..

      - name: âš™ï¸ Install Backend Dependencies
        run: |
          echo "ğŸ“¦ Backend baÄŸÄ±mlÄ±lÄ±klarÄ± kuruluyor..."
          cd backend
          npm install --omit=dev
          echo "âœ… Backend baÄŸÄ±mlÄ±lÄ±klarÄ± kuruldu"
          cd ..

      - name: ğŸ“¦ Archive Backend
        run: |
          echo "ğŸ“¦ Backend arÅŸivleniyor..."
          tar --exclude='node_modules' -czvf backend.tar.gz -C backend .
          echo "âœ… Backend arÅŸivlendi"

      # ==========================================
      # UPLOAD TO VPS
      # ==========================================
      - name: ğŸš€ Copy Archives to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          source: "bot.tar.gz,frontend.tar.gz,backend.tar.gz"
          target: "/root"
          strip_components: 0

      # ==========================================
      # DEPLOY ON VPS - TAMAMEN TEMÄ°Z KURULUM
      # ==========================================
      - name: ğŸ¯ Deploy to VPS (Clean Installation)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            set -e
            
            echo "================================================"
            echo "ğŸš€ NeuroViaBot Deployment BaÅŸlÄ±yor..."
            echo "================================================"
            
            # Ana dizini oluÅŸtur
            mkdir -p /root/neuroviabot/bot
            
            # Eski dosyalarÄ± backup al
            if [ -d "/root/neuroviabot/bot" ] && [ "$(ls -A /root/neuroviabot/bot)" ]; then
              BACKUP_DIR="/root/neuroviabot/bot-backup-$(date +%Y%m%d-%H%M%S)"
              echo "ğŸ“¦ Mevcut dosyalar backup alÄ±nÄ±yor: $BACKUP_DIR"
              cp -r /root/neuroviabot/bot "$BACKUP_DIR" || true
              echo "âœ… Backup tamamlandÄ±"
            fi
            
            # Eski dosyalarÄ± tamamen temizle
            echo "ğŸ§¹ Eski deployment dosyalarÄ± temizleniyor..."
            rm -rf /root/neuroviabot/bot/*
            echo "âœ… Eski dosyalar temizlendi"

            # ==========================================
            # BOT DEPLOYMENT
            # ==========================================
            echo ""
            echo "ğŸ¤– BOT DEPLOYMENT"
            echo "----------------------------------------"
            echo "ğŸ“¦ Bot arÅŸivi Ã§Ä±karÄ±lÄ±yor..."
            tar -xzf /root/bot.tar.gz -C /root/neuroviabot/bot
            echo "âœ… Bot dosyalarÄ± Ã§Ä±karÄ±ldÄ±"
            
            echo "ğŸ§¹ Bot node_modules temizleniyor..."
            cd /root/neuroviabot/bot
            rm -rf node_modules package-lock.json
            
            echo "ğŸ“¦ Bot production baÄŸÄ±mlÄ±lÄ±klarÄ± kuruluyor..."
            npm install --omit=dev
            echo "âœ… Bot hazÄ±r"

            # ==========================================
            # FRONTEND DEPLOYMENT
            # ==========================================
            echo ""
            echo "ğŸŒ FRONTEND DEPLOYMENT"
            echo "----------------------------------------"
            mkdir -p /root/neuroviabot/bot/frontend
            
            echo "ğŸ“¦ Frontend arÅŸivi Ã§Ä±karÄ±lÄ±yor..."
            tar -xzf /root/frontend.tar.gz -C /root/neuroviabot/bot/frontend
            echo "âœ… Frontend dosyalarÄ± Ã§Ä±karÄ±ldÄ±"
            
            echo "ğŸ§¹ Frontend node_modules temizleniyor..."
            cd /root/neuroviabot/bot/frontend
            rm -rf node_modules package-lock.json
            
            echo "ğŸ“¦ Frontend production baÄŸÄ±mlÄ±lÄ±klarÄ± kuruluyor..."
            npm install --omit=dev
            echo "âœ… Frontend hazÄ±r"

            # ==========================================
            # BACKEND DEPLOYMENT
            # ==========================================
            echo ""
            echo "âš™ï¸ BACKEND DEPLOYMENT"
            echo "----------------------------------------"
            mkdir -p /root/neuroviabot/bot/backend
            
            echo "ğŸ“¦ Backend arÅŸivi Ã§Ä±karÄ±lÄ±yor..."
            tar -xzf /root/backend.tar.gz -C /root/neuroviabot/bot/backend
            echo "âœ… Backend dosyalarÄ± Ã§Ä±karÄ±ldÄ±"
            
            echo "ğŸ§¹ Backend node_modules temizleniyor..."
            cd /root/neuroviabot/bot/backend
            rm -rf node_modules package-lock.json
            
            echo "ğŸ“¦ Backend production baÄŸÄ±mlÄ±lÄ±klarÄ± kuruluyor..."
            npm install --omit=dev
            echo "âœ… Backend hazÄ±r"

            # ==========================================
            # PM2 SERVICE RESTART
            # ==========================================
            echo ""
            echo "ğŸ”„ PM2 SERVÄ°SLERÄ° YENÄ°DEN BAÅLATILIYOR"
            echo "================================================"
            
            # Bot servisi
            echo "ğŸ¤– Bot servisi yeniden baÅŸlatÄ±lÄ±yor..."
            pm2 stop neuroviabot || true
            pm2 delete neuroviabot || true
            cd /root/neuroviabot/bot
            pm2 start index.js --name "neuroviabot"
            echo "âœ… Bot servisi baÅŸlatÄ±ldÄ±"
            
            # Frontend servisi
            echo "ğŸŒ Frontend servisi yeniden baÅŸlatÄ±lÄ±yor..."
            pm2 stop neuroviabot-frontend || true
            pm2 delete neuroviabot-frontend || true
            cd /root/neuroviabot/bot/frontend
            pm2 start npm --name "neuroviabot-frontend" -- start
            echo "âœ… Frontend servisi baÅŸlatÄ±ldÄ±"
            
            # Backend servisi
            echo "âš™ï¸ Backend servisi yeniden baÅŸlatÄ±lÄ±yor..."
            pm2 stop neuroviabot-backend || true
            pm2 delete neuroviabot-backend || true
            cd /root/neuroviabot/bot/backend
            pm2 start npm --name "neuroviabot-backend" -- start
            echo "âœ… Backend servisi baÅŸlatÄ±ldÄ±"

            # PM2 kaydet
            pm2 save
            
            echo ""
            echo "ğŸ“Š PM2 DURUM"
            echo "================================================"
            pm2 status

            # ==========================================
            # HEALTH CHECKS
            # ==========================================
            echo ""
            echo "ğŸ¥ HEALTH CHECKS"
            echo "================================================"
            sleep 10
            
            # Frontend health check
            echo "ğŸ” Frontend health check (Port 3001)..."
            if curl -I http://localhost:3001 2>/dev/null; then
              echo "âœ… Frontend Ã§alÄ±ÅŸÄ±yor"
            else
              echo "âš ï¸ Frontend henÃ¼z hazÄ±r deÄŸil (baÅŸlatÄ±lÄ±yor olabilir)"
            fi
            
            # Backend health check
            echo "ğŸ” Backend health check (Port 5000)..."
            if curl -I http://localhost:5000/api/health 2>/dev/null || curl -I http://localhost:5000 2>/dev/null; then
              echo "âœ… Backend Ã§alÄ±ÅŸÄ±yor"
            else
              echo "âš ï¸ Backend henÃ¼z hazÄ±r deÄŸil (baÅŸlatÄ±lÄ±yor olabilir)"
            fi
            
            # Caddy proxy check
            echo "ğŸ” Caddy proxy health check..."
            if curl -I http://localhost:80 2>/dev/null; then
              echo "âœ… Caddy proxy Ã§alÄ±ÅŸÄ±yor"
            else
              echo "âš ï¸ Caddy proxy kontrol edilemedi"
            fi

            # ==========================================
            # CLEANUP
            # ==========================================
            echo ""
            echo "ğŸ§¹ CLEANUP"
            echo "================================================"
            rm -f /root/bot.tar.gz /root/frontend.tar.gz /root/backend.tar.gz
            echo "âœ… GeÃ§ici arÅŸiv dosyalarÄ± temizlendi"

            echo ""
            echo "================================================"
            echo "ğŸ‰ DEPLOYMENT TAMAMLANDI!"
            echo "================================================"
            echo ""
            echo "ğŸ“Š Servis DurumlarÄ±:"
            pm2 status
            echo ""
            echo "ğŸŒ Website: https://neuroviabot.xyz"
            echo "ğŸ”Œ API: https://neuroviabot.xyz/api"
            echo ""

      # ==========================================
      # CLEANUP GITHUB ACTIONS
      # ==========================================
      - name: ğŸ§¹ Cleanup GitHub Actions
        run: |
          echo "ğŸ§¹ GitHub Actions geÃ§ici dosyalar temizleniyor..."
          rm -f bot.tar.gz frontend.tar.gz backend.tar.gz
          echo "âœ… Cleanup tamamlandÄ±"